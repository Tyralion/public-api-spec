# Публичные API

Публичные API делятся на 2 основных класса:

* API платформы - системное API которое позволяет получить доступ к базовым данным платформы.
* API модулей - каждый модуль предоставляет своё собственное API которое реализует именно функции модуля. 



* [Авторизация](#авторизация)
  * [Регистрация приложения](#регистрация-приложения)
  * [Скоупы приложения](#скоупы-приложения)
* [WebHook](#webhook)
  * [Авторизация хука](#авторизация-хука)
  * [Параметры хука](#параметры-хука)
* [OpenAPI спецификации](#openapi-спецификации)



# Авторизация

Для авторизации приложений мы используем oAuth2 и концепцию сервисных аккаунтов. Это означает, что каждое приложение действует не от лица определённого пользователя, а от лица компании. При этом возможность совершать действия от лица определённого пользователя предусмотрена и может быть реализована на уровне API модуля (это зависит исключительно от модуля).

Для возможности выполнения действия от имени пользователя у приложения должен быть скоуп: `user:action`, а при отправке запроса необходимо указать идентификатор пользователя в заголовке `X-User-ID`.

## Регистрация приложения

Для подключения приложения нужно пройти стандартную процедуру регистрации приложения, получения `client_id` и ключей.

* Зайти в интерфейс управления приложениями
* Добавить приложение - получить `client_id`
* Выбрать скоупы в которых может действовать приложение (скоупы платформы и модулей)
* Получить пару ключей для подписи и проверки подписи токенов.

После регистрации приложения нужно выполнить стандартную процедуру получения ключа:

* Сформировать JWT токен
* Запросить токен у сервера авторизации
* Использовать токен полученный на предыдущем шаге для API вызовов

Токен полученный для API вызовов имеет определённый срок действия, если срок действия подошёл к концу, то процедуру получения токена необходимо произвести снова.

## Скоупы приложения

Платформа и модули реализуют определённый набор скоупов в рамках которых приложения могут выполнять определённые действия. Возможность регистрировать много приложений, а также возможность разделять их на скоупы позволяет построить на стороне клиента максимально гибкую систему в плане безопасности.

* users - доступ к данным пользователей
  * users:read - чтение данных пользователей
  * user:write - запись данных пользователей
  * user:action - возможность выполнять действия от имени пользователя в системе
* auth:write - специальный скоуп для управления аутентификационными данными пользователей, читать их можно в скоупе `users:read`
* teams - доступ к организационной структуре компании
  * teams:read - чтение данных организационной структуры
  * teams:write - запись данных организационной структуры

# WebHook

Для обеспечения возможности обратной связи между сервисами TalentTech и внешними интеграциями. Предусмотрен механизм регистрации webhook'ов. Каждое приложение может зарегистрировать не ограниченное количество хуков.

## Авторизация хука

При регистрации хука следует указать секретный токен на основании которого будет вычисляться подпись и передаваться в заголовке `Authorization`, что позволит принимающей стороне однозначно проверить подлинность вызова.

В заголовке передаётся SHA256 хеш от секретного токена.

## Параметры хука

Хук всегда отправляет POST запрос на указный адрес. Внутри POST запрос содержит тело в виде JSON сообщения.

Сообщение содержит следующие ключи

| Ключ           | Описание                                                     |
| -------------- | ------------------------------------------------------------ |
| `company_id`   | Уникальный идентификатор компании в рамках которой произошло событие. |
| `user_id`*     | Уникальный идентификатор пользователя от которого было выполнено действие. Этот идентификатор присутствует в сообщение только в том случае, если при совершении запроса использовался заголовок `X-User-ID` и значение этого заголовка было применимо в запросе. |
| `status`       | Статус выполнения операции, может принимать следующие значения: `success` `error` `info` |
| `module`       | Имя модуля в котором произошло событие.                      |
| `event`        | Уникальное имя события в рамках модуля.                      |
| `description`  | Текстовое описание события                                   |
| `created_at`   | Время первичного возникновения события в системе. Фиксируется именно в момент возникновения. |
| `scheduled_at` | Время первой попытки отправки события                        |
| `retries`      | Количество попыток отправки события, первая отправка всегда содержит `0` |

При регистрации хука можно указать фильтр по полям `module` и `event` , и в результате получать события которые возникают только в определённом модуле(ях) с определёнными идентификаторами.

Все дополнительные ключи которые приходят в сообщении зависят от события и описываются отдельно.

# OpenAPI спецификации

Все спецификации в формате OpenAPI 3.0.1, для просмотра можно воспользоваться публичными инструментами на https://swagger.io/

* [foundation.yaml](foundation.yaml) - API платформы

